[include mainsail.cfg]
[exclude_object] 



[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_1B002B001850344D30353320-if00

# Driver0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
microsteps: 16
rotation_distance: 40
endstop_pin: !PG6
position_endstop: 0
position_max: 374
homing_speed: 100
full_steps_per_rotation: 200

# Driver1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: !PG9
position_endstop: 0
position_min: -7
position_max: 355
homing_speed: 100
full_steps_per_rotation: 200

# Driver2
[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 445
position_min: -6.0
homing_speed: 120
full_steps_per_rotation: 200

# Driver3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200


# Driver4
[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200

# Driver5
[extruder]
max_extrude_only_distance: 1000.0
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
#heater_pin: PA3 # HE1
#sensor_pin: PF5 # T1
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.213
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
heater_pin: PA2 # HE0
sensor_pin:  PF4 # T0
sensor_type: PT1000
pullup_resistor: 4700
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
min_temp: 0
min_extrude_temp: 170
max_temp: 300
max_extrude_cross_section: 5

[heater_bed]
heater_pin: PA1
sensor_pin: PF3 # TB
sensor_type: EPCOS 100K B57560G104F
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

[fan]
pin: PA8

[heater_fan extruder_fan]
pin: PE5

#[heater_fan fan2]
#pin: PD12

#[heater_fan fan3]
#pin: PD13

#[heater_fan fan4]
#pin: PD14

#[controller_fan fan5]
#pin: PD15

[printer]
kinematics: corexy
max_velocity: 380  
max_accel: 28000 
#max_accel_to_decel: 15000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 7

########################################
# TMC2209 configuration
########################################

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: PG6
interpolate: true
run_current: 1.1
#hold_current: 0.500
sense_resistor: 0.110
#driver_TBL: 1
#driver_TOFF: 3
#driver_HSTRT: 3
#driver_HEND: 3
#stealthchop_threshold: 0

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: PG9
interpolate: true
run_current: 1.1
#hold_current: 0.500
sense_resistor: 0.110
#driver_TBL: 1
##driver_TOFF: 3
#driver_HSTRT: 3
#driver_HEND: 3
#stealthchop_threshold: 0

[tmc2209 stepper_z]
uart_pin: PC6
#diag_pin: PG10
run_current: 0.600
#hold_current: 0.500
#interpolate: False
stealthchop_threshold: 999999
sense_resistor: 0.110

[tmc2209 stepper_z1]
uart_pin: PC7
#diag_pin: PG11
run_current: 0.600
#hold_current: 0.500
#interpolate: False
stealthchop_threshold: 999999
sense_resistor: 0.110

[tmc2209 stepper_z2]
uart_pin: PF2
run_current: 0.600
#hold_current: 0.500
#interpolate: False
stealthchop_threshold: 999999
sense_resistor: 0.110

[tmc2209 extruder]
uart_pin: PE4
run_current: .85
hold_current: 0.100
sense_resistor: 0.11 #**
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4

[pause_resume]
recover_velocity: 50.0

#[filament_motion_sensor SFS_T0]
#detection_length: 20 ; This can be adjusted to your desired level of sensitivity. 10 is a recomended value to prevent flow dropoff false triggers.
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True ; This can be set to false to debug false positives putting the sensor in "monitor mode". The printer will not pause but it will run the runout_gcode below. 
#event_delay: 20
#pause_delay: 2
#runout_gcode:
    #M117 Runout Detected!



#[tmc2209 extruder2]
#uart_pin: PE1
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder3]
#uart_pin: PD3
#run_current: 0.800
#stealthchop_threshold: 999999

########################################
# TMC2130 configuration
########################################

#[tmc2130 stepper_x]
#cs_pin: PC4
#spi_bus: spi1
##diag1_pin: PG6
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 stepper_y]
#cs_pin: PD11
#spi_bus: spi1
##diag1_pin: PG9
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 stepper_z]
#cs_pin: PC6
#spi_bus: spi1
##diag1_pin: PG10
#run_current: 0.650
#stealthchop_threshold: 999999

#[tmc2130 stepper_]
#cs_pin: PC7
#spi_bus: spi1
##diag1_pin: PG11
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder]
#cs_pin: PF2
#spi_bus: spi1
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder1]
#cs_pin: PE4
#spi_bus: spi1
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder2]
#cs_pin: PE1
#spi_bus: spi1
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder3]
#cs_pin: PD3
#spi_bus: spi1
#run_current: 0.800
#stealthchop_threshold: 999999

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

# See the sample-lcd.cfg file for definitions of common LCD displays.


# The MCU section only applies to the Eddy USB. For Eddy Coil you will use the MCU name of the toolboard that you connected the Eddy Coil to.
[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_5044466778A0B51C-if00 # This is the serial address of your eddy probe. This can be found by using the terminal of your klipper instance (typically through SSH) and using the command ```ls /dev/serial/by-id``` 
restart_method: command

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu # Sets the type of sensor for Klipper to read
sensor_mcu: eddy # Sets the MCU of the eddy probe tempereature sensor
min_temp: 10 # Sets the minimum tempereature for eddys tempereature sensor to operate
max_temp: 100 # Sets the maximum tempereature for eddys tempereature sensor to operate

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
z_offset: 2.5
#i2c_address:
i2c_mcu: eddy  # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the MCU you have used.
i2c_bus: i2c0f # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the I2C bus you have used.
# Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets
# For a standard Voron stealthburner X carriage mount there should be no need to change the defaults below.
x_offset: 0
y_offset: 21.42

# This section is only relevant for Eddy USB. Comment it out for Eddy Coil.
[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
horizontal_move_z: 2

[bed_mesh]
horizontal_move_z: 2
speed: 200
# For the mesh dimensions below, the coordinates need to be reachable by the center of the probe. To calculate coordinates that will work, use the formula below:
# mesh x min = position_min_x + greater_of (15mm or x_offset) <--- in this term, only consider the x offset if it is positive, ignore if negative.
# mesh y min = position_min_y + greater_of (15mm or y_offset) <--- in this term, only consider the y offset if it is positive, ignore if negative.
# mesh x max = position_max_x - greater_of (15mm or |x_offset|) <--- in this term, only consider the x offset if it is negative, ignore if positive.
# mesh y max = position_max_y - greater_of (15mm or |y_offset|) <--- in this term, only consider the y offset if it is negative, ignore if positive.
# Example: Consider that you have a 300 x 300 bed with the max x and y positions being 300 and the min being 0. Your probe offsets are -20 for X and 10 for Y
# For mesh x min we ignore the x offset term because it is negative. Therefore mesh x min = 15
# For mesh y min we do not ignore the y offset term because it is positive but it is less than 15 so we use 15. Therefore mesh y min = 15
# For mesh x max we do not ignore the x offset term because it is negative. It is also greater than 15. Therefore mesh x max = 280
# For mesh y max we ignore the y offset term because it is positive but it is less than 15 so we use 15. Therefore mesh y max = 285
# The final result would be mesh_min: 15, 15 mesh_max: 280, 285
mesh_min: -38, -10  # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
mesh_max: 300, 290 # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
probe_count: 9, 9
algorithm: bicubic
#scan_overshoot: 8  #uncomment this section if you still have room left over on the X axis for some scan overshoot to product smoother movements and more accurate scanning. Uncommenting this should be fine if you are using a standard voron mount.

# Uncomment this if you are using Eddy as the probe AND the homing endstop
[safe_z_home]
home_xy_position: 150, 170 # Choose an X,Y position that is in the center of your bed. For a 300x300 machine that will be 150, 150. Use the same principle to calculate your bed center.
z_hop: 10
z_hop_speed: 25
speed: 200

###############################Macros and related################################
#This secton contains macros and related config sections. Some should be used, others are optional. Read the comment above each one to find out whether or not to uncomment it for your installation.


# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[save_variables]
filename: ~/printer_data/config/variables.cfg



# Uncomment this if you are using Eddy as the probe AND the homing endstop
[force_move]
enable_force_move: True # Allows a user to move the z axis down if they have no other means of homing Z and need to calibrate the Eddy.



# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[delayed_gcode RESTORE_PROBE_OFFSET]
initial_duration: 1.
gcode:
  {% set svv = printer.save_variables.variables %}
  {% if not printer["gcode_macro SET_GCODE_OFFSET"].restored %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ svv.nvm_offset|default(0) }
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=restored VALUE=True
  {% endif %}



# Uncomment this if you are using Eddy as the probe AND the homing endstop
# Take note of the lines that should only be used if you have a KNOMI installed.
[gcode_macro G28]
rename_existing: G28.1
gcode:
  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=True # Uncomment this if using a KNOMI and then remove the G28 macro from the KNOMI.cfg
  G28.1 {rawparams}
  {% if not rawparams or (rawparams and 'Z' in rawparams) %}
    PROBE
    SET_Z_FROM_PROBE
  {% endif %}
  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=False # Uncomment this if using a KNOMI and then remove the G28 macro from the KNOMI.cfg



# Uncomment this if you are using Eddy as the probe AND the homing endstop
[gcode_macro SET_Z_FROM_PROBE]
gcode:
    {% set cf = printer.configfile.settings %}
    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}
    G90
    G1 Z{cf.safe_z_home.z_hop}


# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro Z_OFFSET_APPLY_PROBE]
rename_existing: Z_OFFSET_APPLY_PROBE_ORIG
gcode:
  SAVE_VARIABLE VARIABLE=nvm_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset }



# Uncomment the lines in this macro if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_ORIG
variable_restored: False  # Mark whether the var has been restored from NVM
variable_runtime_offset: 0
gcode:
  {% if params.Z_ADJUST %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset + params.Z_ADJUST|float }
  {% endif %}
  {% if params.Z %} 
    {% set paramList = rawparams.split() %}
    {% for i in range(paramList|length) %}
      {% if paramList[i]=="Z=0" %}
        {% set temp=paramList.pop(i) %}
        {% set temp="Z_ADJUST=" + (-printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)|string %}
        {% if paramList.append(temp) %}{% endif %}
      {% endif %}
    {% endfor %}
    {% set rawparams=paramList|join(' ') %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE=0
  {% endif %}
  SET_GCODE_OFFSET_ORIG { rawparams }



# This macro automates a lot of the frequency mapping process and simplifies the steps significantly.
[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
  BED_MESH_CLEAR
  G28 X Y
  G90 # Abs positioning
  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
  {% endif %}
  PROBE_EDDY_CURRENT_CALIBRATE {rawparams}



#This macro is optional but useful if you want to run a rapid scan before each print. Simply uncomment it and add BED_MESH_SCAN to your print start code.
[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BTT_BED_MESH_CALIBRATE
gcode:
  SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=True #Only uncomment this line if using a KNOMI and then remove the BED_MESH_CALIBRATE macro from KNOMI.cfg
  BTT_BED_MESH_CALIBRATE METHOD=rapid_scan
  SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=False #Only uncomment this line if using a KNOMI and then remove the BED_MESH_CALIBRATE macro from KNOMI.cfg

#[bed_mesh]
#horizontal_move_z: 5
#mesh_min: -38,-10       #!!min and max co-ords are based on the probes location not the nozzle!!
#mesh_max: 300,290 #needs to be calibrated for your individual printer
#probe_count: 8,8 #this is the number of probing points on X then Y axis
#mesh_pps: 2,2
#algorithm: bicubic
#bicubic_tension: 0.2
#move_check_distance: 5
#split_delta_z: .025
#adaptive_margin: 5

[z_tilt]

z_positions:
   180, -80
   -40, 412
   420, 412
points:
   150, 60
   10, 322
   330, 322
Speed: 100
horizontal_move_z: 10
retries: 7
retry_tolerance: 0.0075


[gcode_arcs]
resolution: 0.1
#   An arc will be split into segments. Each segment's length will
#   equal the resolution in mm set above. Lower values will produce a
#   finer arc, but also more work for your machine. Arcs smaller than
#   the configured value will become straight lines. The default is
#   1mm.

# --------------------------- Start Print ----------------------------

[gcode_macro START_PRINT]

gcode:

    {% set BED_TEMP=params.BED_TEMP|default(80)|float %}
	{% set EXTRUDER_TEMP=params.EXTRUDER_TEMP|default(245)|float %}

    # Wait for bed to reach temperature
    M190 S{BED_TEMP}
    # Set and wait for nozzle to reach temperature
    M109 S{EXTRUDER_TEMP}

    #G1 E-1 ; Retracts filament to prevent blobs during probing

    G90 # use Absolute Positioning 

    G28 

    Z_TILT_ADJUST

    G28 
   
    BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=5

    G92 E0 ; Reset Extruder

    G1 X20.1 Y40 Z0.2 F5000.0 ; Move to start position

    G1 X20.1 Y280.0 Z0.2 F3000.0 E15 ; Draw the first line

    G1 X20.5 Y280.0 Z0.2 F5000.0 ; Move to side a little

    G1 X20.5 Y40 Z0.2 F3000.0 E15 ; Draw the second line

    G92 E0 ; Reset Extruder

    G1 Z2.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed

    G1 E-2 F300 ; retract a little bit


    
[gcode_macro END_PRINT]

gcode:

    M106 S0 ;Turn-off fan 

    M104 S0 ;Turn-off hotend

    M140 S0 ;Turn-off bed

    G90 

    G1 X0 Y0  ;Present print

    G91

    G1 Z50

    G1 E-2 F300

    M84 X Y E ;Disable all steppers but Z

    #SET_FILAMENT_SENSOR SENSOR=SFS_T0 ENABLE=0 ; Put your filament sensor's name after SENSOR=
# --------------Filament Load and Unload-----------------

[gcode_macro UNLOAD_FILAMENT]
gcode:
    ; Unload
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(230)|float %}   
    G91 ; Set positioning to Relative
    G1 E5 F120
    G1 E-100 F3000
    G1 E-50 F360
    G92 E0 ; Reset Extruder


[gcode_macro LOAD_FILAMENT]
gcode:
    ; Load
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(230)|float %} 
    G91 ; Set positioning to Relative
    G1 E500 F300
    G1 E50 F300
    G92 E0 ; Reset Extruder

[gcode_macro ProbeCalibrate]

description: start process because I'm forgetful 

gcode:

    G28

    probe_calibrate


# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10


[temperature_sensor klipper_host]
sensor_type: temperature_host
sensor_path: /sys/class/thermal/thermal_zone0/temp

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 0.569
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 26.743
#*# pid_ki = 2.073
#*# pid_kd = 86.245
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3298065.530,0.090000:3297329.364,0.130000:3296665.059,
#*# 	0.170000:3296240.038,0.210000:3296140.242,0.250000:3295649.655,
#*# 	0.290000:3295111.352,0.330000:3294869.326,0.370000:3294565.913,
#*# 	0.410000:3293318.834,0.450000:3292140.217,0.490000:3290989.811,
#*# 	0.530000:3289864.479,0.570000:3288710.178,0.610000:3287609.156,
#*# 	0.650000:3286551.213,0.690000:3285507.320,0.730000:3284425.102,
#*# 	0.770000:3283402.593,0.810000:3282437.203,0.850000:3281450.827,
#*# 	0.890000:3280468.131,0.930000:3279523.516,0.970000:3278604.634,
#*# 	1.010000:3277714.219,1.050000:3276775.202,1.090000:3275892.667,
#*# 	1.130000:3275054.784,1.170000:3274263.147,1.210000:3273388.894,
#*# 	1.250000:3272567.909,1.290000:3271749.398,1.330000:3271035.907,
#*# 	1.370000:3270236.650,1.410000:3269464.821,1.450000:3268755.749,
#*# 	1.490000:3268015.459,1.530000:3267318.984,1.570000:3266623.009,
#*# 	1.610000:3265941.651,1.650000:3265311.241,1.690000:3264599.185,
#*# 	1.730000:3263954.612,1.770000:3263333.246,1.810000:3262739.500,
#*# 	1.850000:3262098.464,1.890000:3261532.223,1.930000:3260938.620,
#*# 	1.970000:3260391.508,2.010000:3259799.348,2.050000:3259268.072,
#*# 	2.090000:3258732.580,2.130000:3258188.785,2.170000:3257685.054,
#*# 	2.210000:3257161.666,2.250000:3256670.394,2.290000:3256188.732,
#*# 	2.330000:3255683.574,2.370000:3255205.005,2.410000:3254762.543,
#*# 	2.450000:3254293.497,2.490000:3253867.799,2.530000:3253405.955,
#*# 	2.570000:3252971.397,2.610000:3252582.915,2.650000:3252145.024,
#*# 	2.690000:3251726.752,2.730000:3251343.058,2.770000:3250968.257,
#*# 	2.810000:3250572.953,2.850000:3250189.334,2.890000:3249814.757,
#*# 	2.930000:3249451.652,2.970000:3249077.357,3.010000:3248723.581,
#*# 	3.050000:3248375.235,3.090000:3248033.649,3.130000:3247708.473,
#*# 	3.170000:3247376.175,3.210000:3247063.733,3.250000:3246724.144,
#*# 	3.290000:3246426.417,3.330000:3246106.580,3.370000:3245844.923,
#*# 	3.410000:3245523.913,3.450000:3245228.857,3.490000:3244949.774,
#*# 	3.530000:3244662.688,3.570000:3244399.579,3.610000:3244110.083,
#*# 	3.650000:3243852.088,3.690000:3243591.241,3.730000:3243334.336,
#*# 	3.770000:3243062.310,3.810000:3242815.268,3.850000:3242614.440,
#*# 	3.890000:3242350.940,3.930000:3242103.921,3.970000:3241889.210,
#*# 	4.010000:3241625.000,4.050000:3241408.101
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 34.051898
